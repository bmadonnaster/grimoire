default_pre_build      &&
cd "$SOURCE_DIRECTORY" &&

apply_patch_dir patches &&

# Fix linking of dvisvgm; configure is broken
sedit 's/@LIBGS_LIBS@/-lgs/' texk/dvisvgm/dvisvgm-src/src/Makefile.in &&

# removing as much internal things as possible
      #asymptote \
      #devnag \
      #lacheck \
      #m-tx \
      #pmx \
      #texdoctk \
      #tpic2pdftex \
      #vlna \
      #xindy \
for i in \
      ps2eps \
      t1utils \
      xpdfopen
do
  rm -rf utils/"$i"
done &&

# Override bundled libraries' buildsystems to force system versions
# XXX lua52 and luajit can't be so easily removed due to internal API
# dependencies.
for i in \
      cairo \
      freetype2 \
      gd \
      gmp \
      graphite2 \
      harfbuzz \
      icu \
      libpaper \
      libpng \
      mpfr \
      pixman \
      poppler \
      potrace \
      xpdf \
      zlib \
      zziplib
do
  rm -rf libs/"$i" &&
  mkdir  libs/"$i" &&
  cat <<"!" > libs/"$i"/configure &&
#!/bin/sh
echo '%:;echo $@ target suppressed' > Makefile
!
  chmod 755 libs/"$i"/configure
done &&

# Use /usr/share/texmf and /usr/share/texmf-dist, adapted from lunarlinux
find \( -name Makefile\* -o -name configure \) \
       -exec sed -i -e "s:\(\$.\)prefix\(./tex\):\1datadir\2:" {} + \
  -o \( -name \*.info -o -name \*.texi \) \
       -exec sed -i -e "s:/usr/local:/usr:" {} + &&

# Patch paths in texmf.cnf
sedit '
	s@^TEXMFROOT =.*@&/usr/share@
	/^TEXMFLOCAL =/  s@=.*@= $SELFAUTODIR/local/share/texmf@
	/^TEXMFSYSVAR =/ s@=.*@= /var/tmp/texmf-var@
' texk/kpathsea/texmf.cnf &&

# ICU fix
sed '/utypes.h/i\
#include <unicode/utf16.h>
' -i texk/upmendex/mendex.h &&

mkdir "$COMPILE_DIRECTORY" &&

# Poppler sources:
# really old: keep things as-is
# 0.59.x to 0.68.x: pdftoepdf-poppler0.68.0.cc, pdftosrc-newpoppler.cc
# 0.69.x: pdftoepdf-poppler0.69.0.cc, pdftosrc-newpoppler.cc
# 0.70.x: pdftoepdf-poppler0.70.0.cc, pdftosrc-newpoppler.cc
# 0.71.x: pdftoepdf-poppler0.71.0.cc, pdftosrc-poppler0.71.0.cc
# This is nuts.
if spell_ok poppler; then
  cd "${SOURCE_DIRECTORY}/texk/web2c/pdftexdir" &&
  popplerver="$(installed_version poppler | cut -f 1,2 -d .)" &&
  if is_version_between 0.59 "$popplerver" 0.68; then
    cp pdftoepdf-poppler0.68.0.cc pdftoepdf.cc &&
    cp pdftosrc-newpoppler.cc pdftosrc.cc
  elif [[ "$popplerver" = 0.69 ]]; then
    cp pdftoepdf-poppler0.69.0.cc pdftoepdf.cc &&
    cp pdftosrc-newpoppler.cc pdftosrc.cc
  elif [[ "$popplerver" = 0.70 ]]; then
    cp pdftoepdf-poppler0.70.0.cc pdftoepdf.cc &&
    cp pdftosrc-newpoppler.cc pdftosrc.cc
  elif [[ "$popplerver" = 0.71 ]]; then
    cp pdftoepdf-poppler0.71.0.cc pdftoepdf.cc &&
    cp pdftosrc-poppler0.71.0.cc pdftosrc.cc
  elif [[ "$popplerver" = 0.72 ]]; then
    cp pdftoepdf-poppler0.72.0.cc pdftoepdf.cc &&
    cp pdftosrc-poppler0.72.0.cc pdftosrc.cc
  elif ! is_version_less "$popplerver" 0.73; then
    cp pdftoepdf-poppler0.75.0.cc pdftoepdf.cc &&
    cp pdftosrc-poppler0.72.0.cc pdftosrc.cc
  fi &&
  cd "${SOURCE_DIRECTORY}"
fi
