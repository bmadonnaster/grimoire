# From https://github.com/themiron/dnsmasq/commit/162e5e0062ce923c494cc64282f293f0ed64fc10
# Fix returning NODATA instead of NXDOMAIN, introduced in 2.80
# See https://bugzilla.redhat.com/show_bug.cgi?id=1674067
diff --git a/CHANGELOG b/CHANGELOG
index 0673fc7..08bfda9 100644
--- a/CHANGELOG
+++ b/CHANGELOG
@@ -21,6 +21,11 @@ version 2.81
 	correct error messages. Thanks to Christian Rosentreter
 	for reporting this.
 
+	Fix bug in DNS non-terminal code, added in 2.80, which could
+	sometimes cause a NODATA rather than an NXDOMAIN reply.
+	Thanks to Sven Mueller and Maciej Å»enczykowski for spotting
+	and diagnosing the bug and providing patches.
+
 
 version 2.80
 	Add support for RFC 4039 DHCP rapid commit. Thanks to Ashram Method
diff --git a/src/cache.c b/src/cache.c
index 906f5e1..44c13e4 100644
--- a/src/cache.c
+++ b/src/cache.c
@@ -790,6 +790,7 @@ int cache_find_non_terminal(char *name, time_t now)
     if (!is_outdated_cname_pointer(crecp) &&
 	!is_expired(now, crecp) &&
 	(crecp->flags & F_FORWARD) &&
+	!(crecp->flags & F_NXDOMAIN) && 
 	hostname_isequal(name, cache_get_name(crecp)))
       return 1;
 
