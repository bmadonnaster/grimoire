default_pre_build &&
cd "$SOURCE_DIRECTORY" &&

# Respect custom build flags
find -name Makefile.linux -exec \
    sed -i -e '/FLAGS[\t ]*=/s/=/+=/' {} + &&

sed -i -e '/(CC) -o [^.]* /s/ -o / $(LDFLAGS)&/' \
    chat/Makefile.linux \
    pppd/plugins/rp-pppoe/Makefile.linux \
    pppdump/Makefile.linux &&

# include mppe.h into build
patch -p0 < "$SPELL_DIRECTORY/mppe-header.patch" &&

sedit  's:net/bpf.h:pcap-bpf.h:'     pppd/demand.c       &&
sedit  's:net/bpf.h:pcap-bpf.h:'     pppd/sys-linux.c    &&
sedit  's:/usr/man:/usr/share/man:'  linux/Makefile.top  &&

if is_depends_enabled $SPELL linux-pam; then
  sedit 's:#USE_PAM=y:USE_PAM=y:' pppd/Makefile.linux
fi &&

if ! is_depends_enabled $SPELL shadow; then
  sedit 's:HAS_SHADOW=y:#HAS_SHADOW=y:' pppd/Makefile.linux
fi &&

if [ "$HAVE_INET6" == "y" ]; then
  sedit 's:#HAVE_INET6=y:HAVE_INET6=y:' pppd/Makefile.linux
fi &&

if [ "$HAVE_CBCP" == "y" ]; then
  sedit  's:#CBCP=y:CBCP=y:'         pppd/Makefile.linux
fi
