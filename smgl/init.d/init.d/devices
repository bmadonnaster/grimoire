#!/bin/bash

PROGRAM=/bin/false
RUNLEVEL=DEV
ESSENTIAL=yes

. /etc/init.d/smgl_init
. /etc/sysconfig/devices

udev_mknodes()
{
# eudev creates these; errors if they are already present
UD=`/bin/udevadm --version`
if [[ $UD < '220' ]];then
  if [ ! -d $udev_root/fd ]; then
    ln -fs /proc/self/fd $udev_root/fd
  fi
  ln -s /dev/fd/0 $udev_root/stdin
  ln -s /dev/fd/1 $udev_root/stdout
  ln -s /dev/fd/2 $udev_root/stderr
fi
  mkdir $udev_root/shm
  mkdir $udev_root/pts
}

start_udev()
{ (
  . /etc/udev/udev.conf
  echo "Checking if devtmpfs or ramfs is used for $udev_root ..."
  if findmnt devtmpfs > /dev/null 2>&1; then
    echo "devtmpfs is used for $udev_root"
  else
    echo "ramfs is used for $udev_root"
    echo "Mounting ramfs at $udev_root"
    mount -n -t ramfs none $udev_root
  fi
  # create some needed stuff
  udev_mknodes

  # kernel 2.6.15-rc1 and higher don't use hotplug
  if [[ $(printf "%s\n%s\n" "$(uname -r)" "2.6.15" | sort -V | head -n 1) \
        = 2.6.15 ]]; then
    echo "don't need hotplug for this kernel"
    builtin echo > /proc/sys/kernel/hotplug
  else
      # Now uses udevsend as the hotplug multiplexer
    echo "Setting udevsend as hotplug agent"
    sysctl -w kernel.hotplug="/sbin/udevsend" > /dev/null 2>&1
    echo "Creating initial udev device nodes"
    /sbin/udevstart
  fi

  echo "Telling init to reopen file descriptors"
  kill -USR1 1
) }

start_static_udev()
{ (
  . /etc/udev/udev.conf
  # create some needed stuff - and insist on it
  udev_mknodes

  # kernel 2.6.15-rc1 and higher don't use hotplug
  if [[ $(printf "%s\n%s\n" "$(uname -r)" "2.6.15" | sort -V | head -n 1) \
        = 2.6.15 ]]; then
    echo "don't need hotplug for this kernel"
    builtin echo > /proc/sys/kernel/hotplug
  else
      # Now uses udevsend as the hotplug multiplexer
    echo "Setting udevsend as hotplug agent"
    sysctl -w kernel.hotplug="/sbin/udevsend" > /dev/null 2>&1
    echo "Creating initial udev device nodes"
    /sbin/udevstart
  fi

) }

start_static()
{
   exit 0
}

start()
{
  # mount proc
  echo "Mounting /proc"
  mount -n -t proc proc /proc
  # mount sys
  echo "Mounting /sys"
  mount -n -t sysfs sysfs /sys
  # mount run
  echo "Mounting /run"
  mount -n -o size=${RUN_SIZE:-50%} -t tmpfs tmpfs /run
  eval "start_$DEVICES"
}

stop() { exit 0; }
restart() { exit 3; }
reload() { exit 3; }
force_reload() { exit 3; }
status() { exit 3; }

usage()
{
  echo "Usage: $0 {start|stop}"
  echo "Warning: Do not run this script manually!"
}
