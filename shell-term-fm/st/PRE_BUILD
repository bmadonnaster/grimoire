default_pre_build &&
cd ${SOURCE_DIRECTORY} &&

# Apply optional patches
i=2
while src=$(eval 'echo "$SOURCE'"$i"\")
      [[ -n "$src" ]]
do
  desc=$(sed -r '/^Subject: /!d;s@^[^ ]+ (\[[^]]+\] *)*@@;q' \
	     "$SOURCE_CACHE/$src")
  if query "Apply $src ($desc)?" n; then
    patch -fp1 -i "$SOURCE_CACHE/$src" || exit 1

    if [ "$src" = "st-xresources-signal-reloading-20220407-ef05519.diff" ]; then
      if grep -q "cursorstyle = 1" config.def.h; then
        sedit "s:XRESOURCE_LOAD_INTEGER(\"cursorshape\", cursorshape);:XRESOURCE_LOAD_INTEGER(\"cursorstyle\", cursorstyle);:" x.c &&
        patch -p0 < "${SPELL_DIRECTORY}/xsetcursor.patch"
      fi

      if grep -q "alpha = 0.8" config.def.h; then
        sedit "s:XRESOURCE_LOAD_FLOAT(\"chscale\", chscale);:XRESOURCE_LOAD_FLOAT(\"chscale\", chscale); XRESOURCE_LOAD_FLOAT(\"alpha\", alpha);:" x.c
      fi
    fi
  fi
  let i++
done

if [[ "${ST_CONFIG}" == "y" ]]; then
  if [[ -e ${INSTALL_ROOT}/usr/share/doc/st/config.def.h ]]; then
    cp ${INSTALL_ROOT}/usr/share/doc/st/config.def.h ./
  fi &&
  if query 'Do you want to edit your config now?' n; then
    if [ -z"$EDITOR" ]; then
      . /etc/profile.d/editor.sh
    fi
    ${EDITOR:-nano} config.def.h
  fi
fi
